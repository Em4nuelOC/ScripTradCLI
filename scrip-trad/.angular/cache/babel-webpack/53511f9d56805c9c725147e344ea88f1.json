{"ast":null,"code":"import _asyncToGenerator from \"E:/DAW/2/ScripTrad/ScripTradCLI/scrip-trad/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";\nimport _wrapAsyncGenerator from \"E:/DAW/2/ScripTrad/ScripTradCLI/scrip-trad/node_modules/@babel/runtime/helpers/esm/wrapAsyncGenerator\";\nimport _awaitAsyncGenerator from \"E:/DAW/2/ScripTrad/ScripTradCLI/scrip-trad/node_modules/@babel/runtime/helpers/esm/awaitAsyncGenerator\";\nimport _asyncGeneratorDelegate from \"E:/DAW/2/ScripTrad/ScripTradCLI/scrip-trad/node_modules/@babel/runtime/helpers/esm/asyncGeneratorDelegate\";\n\nfunction _asyncIterator(iterable) { var method, async, sync, retry = 2; for (\"undefined\" != typeof Symbol && (async = Symbol.asyncIterator, sync = Symbol.iterator); retry--;) { if (async && null != (method = iterable[async])) return method.call(iterable); if (sync && null != (method = iterable[sync])) return new AsyncFromSyncIterator(method.call(iterable)); async = \"@@asyncIterator\", sync = \"@@iterator\"; } throw new TypeError(\"Object is not async iterable\"); }\n\nfunction AsyncFromSyncIterator(s) { function AsyncFromSyncIteratorContinuation(r) { if (Object(r) !== r) return Promise.reject(new TypeError(r + \" is not an object.\")); var done = r.done; return Promise.resolve(r.value).then(function (value) { return { value: value, done: done }; }); } return AsyncFromSyncIterator = function (s) { this.s = s, this.n = s.next; }, AsyncFromSyncIterator.prototype = { s: null, n: null, next: function () { return AsyncFromSyncIteratorContinuation(this.n.apply(this.s, arguments)); }, return: function (value) { var ret = this.s.return; return void 0 === ret ? Promise.resolve({ value: value, done: !0 }) : AsyncFromSyncIteratorContinuation(ret.apply(this.s, arguments)); }, throw: function (value) { var thr = this.s.return; return void 0 === thr ? Promise.reject(value) : AsyncFromSyncIteratorContinuation(thr.apply(this.s, arguments)); } }, new AsyncFromSyncIterator(s); }\n\nimport { errors } from '../util.js';\n/** @type {typeof window.File} */\n\nconst File = globalThis.File || (await import('fetch-blob/file.js').then(m => m.File));\n/** @type {typeof window.Blob} */\n\nconst Blob = globalThis.Blob || (await import('fetch-blob').then(m => m.Blob));\nconst {\n  INVALID,\n  GONE,\n  MISMATCH,\n  MOD_ERR,\n  SYNTAX,\n  SECURITY,\n  DISALLOWED\n} = errors;\nexport class Sink {\n  /**\n   * @param {FileHandle} fileHandle\n   * @param {File} file\n   */\n  constructor(fileHandle, file) {\n    this.fileHandle = fileHandle;\n    this.file = file;\n    this.size = file.size;\n    this.position = 0;\n  }\n\n  write(chunk) {\n    let file = this.file;\n\n    if (typeof chunk === 'object') {\n      if (chunk.type === 'write') {\n        if (Number.isInteger(chunk.position) && chunk.position >= 0) {\n          this.position = chunk.position;\n\n          if (this.size < chunk.position) {\n            this.file = new File([this.file, new ArrayBuffer(chunk.position - this.size)], this.file.name, this.file);\n          }\n        }\n\n        if (!('data' in chunk)) {\n          throw new DOMException(...SYNTAX('write requires a data argument'));\n        }\n\n        chunk = chunk.data;\n      } else if (chunk.type === 'seek') {\n        if (Number.isInteger(chunk.position) && chunk.position >= 0) {\n          if (this.size < chunk.position) {\n            throw new DOMException(...INVALID);\n          }\n\n          this.position = chunk.position;\n          return;\n        } else {\n          throw new DOMException(...SYNTAX('seek requires a position argument'));\n        }\n      } else if (chunk.type === 'truncate') {\n        if (Number.isInteger(chunk.size) && chunk.size >= 0) {\n          file = chunk.size < this.size ? new File([file.slice(0, chunk.size)], file.name, file) : new File([file, new Uint8Array(chunk.size - this.size)], file.name);\n          this.size = file.size;\n\n          if (this.position > file.size) {\n            this.position = file.size;\n          }\n\n          this.file = file;\n          return;\n        } else {\n          throw new DOMException(...SYNTAX('truncate requires a size argument'));\n        }\n      }\n    }\n\n    chunk = new Blob([chunk]);\n    let blob = this.file; // Calc the head and tail fragments\n\n    const head = blob.slice(0, this.position);\n    const tail = blob.slice(this.position + chunk.size); // Calc the padding\n\n    let padding = this.position - head.size;\n\n    if (padding < 0) {\n      padding = 0;\n    }\n\n    blob = new File([head, new Uint8Array(padding), chunk, tail], blob.name);\n    this.size = blob.size;\n    this.position += chunk.size;\n    this.file = blob;\n  }\n\n  close() {\n    if (this.fileHandle._deleted) throw new DOMException(...GONE);\n    this.fileHandle._file = this.file;\n    this.file = this.position = this.size = null;\n\n    if (this.fileHandle.onclose) {\n      this.fileHandle.onclose(this.fileHandle);\n    }\n  }\n\n}\nexport class FileHandle {\n  constructor(name = '', file = new File([], name), writable = true) {\n    this._file = file;\n    this.name = name;\n    this.kind = 'file';\n    this._deleted = false;\n    this.writable = writable;\n    this.readable = true;\n  }\n\n  getFile() {\n    var _this2 = this;\n\n    return _asyncToGenerator(function* () {\n      if (_this2._deleted) throw new DOMException(...GONE);\n      return _this2._file;\n    })();\n  }\n\n  createWritable(opts) {\n    var _this3 = this;\n\n    return _asyncToGenerator(function* () {\n      if (!_this3.writable) throw new DOMException(...DISALLOWED);\n      if (_this3._deleted) throw new DOMException(...GONE);\n      const file = opts.keepExistingData ? yield _this3.getFile() : new File([], _this3.name);\n      return new Sink(_this3, file);\n    })();\n  }\n\n  isSameEntry(other) {\n    var _this4 = this;\n\n    return _asyncToGenerator(function* () {\n      return _this4 === other;\n    })();\n  }\n\n  _destroy() {\n    var _this5 = this;\n\n    return _asyncToGenerator(function* () {\n      _this5._deleted = true;\n      _this5._file = null;\n    })();\n  }\n\n}\nexport class FolderHandle {\n  /** @param {string} name */\n  constructor(name, writable = true) {\n    this.name = name;\n    this.kind = 'directory';\n    this._deleted = false;\n    /** @type {Object.<string, (FolderHandle|FileHandle)>} */\n\n    this._entries = {};\n    this.writable = writable;\n    this.readable = true;\n  }\n  /** @returns {AsyncGenerator<[string, FileHandle | FolderHandle]>} */\n\n\n  entries() {\n    var _this = this;\n\n    return _wrapAsyncGenerator(function* () {\n      if (_this._deleted) throw new DOMException(...GONE);\n      yield* _asyncGeneratorDelegate(_asyncIterator(Object.entries(_this._entries)), _awaitAsyncGenerator);\n    })();\n  }\n\n  isSameEntry(other) {\n    var _this6 = this;\n\n    return _asyncToGenerator(function* () {\n      return _this6 === other;\n    })();\n  }\n  /**\n   * @param {string} name\n   * @param {{ create: boolean; }} opts\n   */\n\n\n  getDirectoryHandle(name, opts) {\n    var _this7 = this;\n\n    return _asyncToGenerator(function* () {\n      if (_this7._deleted) throw new DOMException(...GONE);\n      const entry = _this7._entries[name];\n\n      if (entry) {\n        // entry exist\n        if (entry instanceof FileHandle) {\n          throw new DOMException(...MISMATCH);\n        } else {\n          return entry;\n        }\n      } else {\n        if (opts.create) {\n          return _this7._entries[name] = new FolderHandle(name);\n        } else {\n          throw new DOMException(...GONE);\n        }\n      }\n    })();\n  }\n  /**\n   * @param {string} name\n   * @param {{ create: boolean; }} opts\n   */\n\n\n  getFileHandle(name, opts) {\n    var _this8 = this;\n\n    return _asyncToGenerator(function* () {\n      const entry = _this8._entries[name];\n      const isFile = entry instanceof FileHandle;\n      if (entry && isFile) return entry;\n      if (entry && !isFile) throw new DOMException(...MISMATCH);\n      if (!entry && !opts.create) throw new DOMException(...GONE);\n\n      if (!entry && opts.create) {\n        return _this8._entries[name] = new FileHandle(name);\n      }\n    })();\n  }\n\n  removeEntry(name, opts) {\n    var _this9 = this;\n\n    return _asyncToGenerator(function* () {\n      const entry = _this9._entries[name];\n      if (!entry) throw new DOMException(...GONE);\n      yield entry._destroy(opts.recursive);\n      delete _this9._entries[name];\n    })();\n  }\n\n  _destroy(recursive) {\n    var _this10 = this;\n\n    return _asyncToGenerator(function* () {\n      for (let x of Object.values(_this10._entries)) {\n        if (!recursive) throw new DOMException(...MOD_ERR);\n        yield x._destroy(recursive);\n      }\n\n      _this10._entries = {};\n      _this10._deleted = true;\n    })();\n  }\n\n}\nconst fs = new FolderHandle('');\nexport default (() => fs);","map":{"version":3,"sources":["E:/DAW/2/ScripTrad/ScripTradCLI/scrip-trad/node_modules/native-file-system-adapter/src/adapters/memory.js"],"names":["errors","File","globalThis","then","m","Blob","INVALID","GONE","MISMATCH","MOD_ERR","SYNTAX","SECURITY","DISALLOWED","Sink","constructor","fileHandle","file","size","position","write","chunk","type","Number","isInteger","ArrayBuffer","name","DOMException","data","slice","Uint8Array","blob","head","tail","padding","close","_deleted","_file","onclose","FileHandle","writable","kind","readable","getFile","createWritable","opts","keepExistingData","isSameEntry","other","_destroy","FolderHandle","_entries","entries","Object","getDirectoryHandle","entry","create","getFileHandle","isFile","removeEntry","recursive","x","values","fs"],"mappings":"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","sourcesContent":["import { errors } from '../util.js'\n/** @type {typeof window.File} */\nconst File = globalThis.File || await import('fetch-blob/file.js').then(m => m.File)\n/** @type {typeof window.Blob} */\nconst Blob = globalThis.Blob || await import('fetch-blob').then(m => m.Blob)\n\nconst { INVALID, GONE, MISMATCH, MOD_ERR, SYNTAX, SECURITY, DISALLOWED } = errors\n\nexport class Sink {\n\n  /**\n   * @param {FileHandle} fileHandle\n   * @param {File} file\n   */\n  constructor (fileHandle, file) {\n    this.fileHandle = fileHandle\n    this.file = file\n    this.size = file.size\n    this.position = 0\n  }\n\n  write (chunk) {\n    let file = this.file\n\n    if (typeof chunk === 'object') {\n      if (chunk.type === 'write') {\n        if (Number.isInteger(chunk.position) && chunk.position >= 0) {\n          this.position = chunk.position\n          if (this.size < chunk.position) {\n            this.file = new File(\n              [this.file, new ArrayBuffer(chunk.position - this.size)],\n              this.file.name,\n              this.file\n            )\n          }\n        }\n        if (!('data' in chunk)) {\n          throw new DOMException(...SYNTAX('write requires a data argument'))\n        }\n        chunk = chunk.data\n      } else if (chunk.type === 'seek') {\n        if (Number.isInteger(chunk.position) && chunk.position >= 0) {\n          if (this.size < chunk.position) {\n            throw new DOMException(...INVALID)\n          }\n          this.position = chunk.position\n          return\n        } else {\n          throw new DOMException(...SYNTAX('seek requires a position argument'))\n        }\n      } else if (chunk.type === 'truncate') {\n        if (Number.isInteger(chunk.size) && chunk.size >= 0) {\n          file = chunk.size < this.size\n            ? new File([file.slice(0, chunk.size)], file.name, file)\n            : new File([file, new Uint8Array(chunk.size - this.size)], file.name)\n\n          this.size = file.size\n          if (this.position > file.size) {\n            this.position = file.size\n          }\n          this.file = file\n          return\n        } else {\n          throw new DOMException(...SYNTAX('truncate requires a size argument'))\n        }\n      }\n    }\n\n    chunk = new Blob([chunk])\n\n    let blob = this.file\n    // Calc the head and tail fragments\n    const head = blob.slice(0, this.position)\n    const tail = blob.slice(this.position + chunk.size)\n\n    // Calc the padding\n    let padding = this.position - head.size\n    if (padding < 0) {\n      padding = 0\n    }\n    blob = new File([\n      head,\n      new Uint8Array(padding),\n      chunk,\n      tail\n    ], blob.name)\n\n    this.size = blob.size\n    this.position += chunk.size\n\n    this.file = blob\n  }\n  close () {\n    if (this.fileHandle._deleted) throw new DOMException(...GONE)\n    this.fileHandle._file = this.file\n    this.file =\n    this.position =\n    this.size = null\n    if (this.fileHandle.onclose) {\n      this.fileHandle.onclose(this.fileHandle)\n    }\n  }\n}\n\nexport class FileHandle {\n  constructor (name = '', file = new File([], name), writable = true) {\n    this._file = file\n    this.name = name\n    this.kind = 'file'\n    this._deleted = false\n    this.writable = writable\n    this.readable = true\n  }\n\n  async getFile () {\n    if (this._deleted) throw new DOMException(...GONE)\n    return this._file\n  }\n\n  async createWritable (opts) {\n    if (!this.writable) throw new DOMException(...DISALLOWED)\n    if (this._deleted) throw new DOMException(...GONE)\n\n    const file = opts.keepExistingData\n      ? await this.getFile()\n      : new File([], this.name)\n\n    return new Sink(this, file)\n  }\n\n  async isSameEntry (other) {\n    return this === other\n  }\n\n  async _destroy () {\n    this._deleted = true\n    this._file = null\n  }\n}\n\nexport class FolderHandle {\n\n  /** @param {string} name */\n  constructor (name, writable = true) {\n    this.name = name\n    this.kind = 'directory'\n    this._deleted = false\n    /** @type {Object.<string, (FolderHandle|FileHandle)>} */\n    this._entries = {}\n    this.writable = writable\n    this.readable = true\n  }\n\n  /** @returns {AsyncGenerator<[string, FileHandle | FolderHandle]>} */\n  async * entries () {\n    if (this._deleted) throw new DOMException(...GONE)\n    yield* Object.entries(this._entries)\n  }\n\n  async isSameEntry (other) {\n    return this === other\n  }\n\n  /**\n   * @param {string} name\n   * @param {{ create: boolean; }} opts\n   */\n  async getDirectoryHandle (name, opts) {\n    if (this._deleted) throw new DOMException(...GONE)\n    const entry = this._entries[name]\n    if (entry) { // entry exist\n      if (entry instanceof FileHandle) {\n        throw new DOMException(...MISMATCH)\n      } else {\n        return entry\n      }\n    } else {\n      if (opts.create) {\n        return (this._entries[name] = new FolderHandle(name))\n      } else {\n        throw new DOMException(...GONE)\n      }\n    }\n  }\n\n  /**\n   * @param {string} name\n   * @param {{ create: boolean; }} opts\n   */\n  async getFileHandle (name, opts) {\n    const entry = this._entries[name]\n    const isFile = entry instanceof FileHandle\n    if (entry && isFile) return entry\n    if (entry && !isFile) throw new DOMException(...MISMATCH)\n    if (!entry && !opts.create) throw new DOMException(...GONE)\n    if (!entry && opts.create) {\n      return (this._entries[name] = new FileHandle(name))\n    }\n  }\n\n  async removeEntry (name, opts) {\n    const entry = this._entries[name]\n    if (!entry) throw new DOMException(...GONE)\n    await entry._destroy(opts.recursive)\n    delete this._entries[name]\n  }\n\n  async _destroy (recursive) {\n    for (let x of Object.values(this._entries)) {\n      if (!recursive) throw new DOMException(...MOD_ERR)\n      await x._destroy(recursive)\n    }\n    this._entries = {}\n    this._deleted = true\n  }\n}\n\nconst fs = new FolderHandle('')\n\nexport default () => fs\n"]},"metadata":{},"sourceType":"module"}